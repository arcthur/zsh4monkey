#!/usr/bin/env zsh
#
# Initialize CLI tool replacements (eza, bat, zoxide)
# Uses system-installed tools only
#
# Configuration: zstyle ':z4m:eza' enabled no
#

emulate -L zsh -o typeset_silent -o pipe_fail -o extended_glob \
    -o prompt_percent -o no_prompt_subst -o no_prompt_bang -o no_bg_nice -o no_aliases

# eza -> ls
if zstyle -T :z4m:eza enabled && (( $+commands[eza] )); then
  alias ls="eza --group-directories-first"
  alias ll="eza -la --group-directories-first"
  alias la="eza -a --group-directories-first"
  alias lt="eza --tree --level=2"
  alias tree="eza --tree"
fi

# bat -> cat
if zstyle -T :z4m:bat enabled && (( $+commands[bat] )); then
  alias cat="bat --paging=never --style=plain"
  alias bat="bat"
  export BAT_THEME=${BAT_THEME:-TwoDark}
  [[ -n $MANPAGER ]] || {
    export MANPAGER="sh -c 'col -bx | bat -l man -p'"
    export MANROFFOPT="-c"
  }
fi

# fd and rg: no aliases needed, just verify they exist for zstyle checks

# zoxide -> z
if zstyle -T :z4m:zoxide enabled && (( $+commands[zoxide] )); then
  local cache_dir=$Z4M/cache/zoxide-$EUID
  local cache_file=$cache_dir/init.zsh
  local cache_valid=0

  [[ -d $cache_dir ]] || zf_mkdir -p -- "$cache_dir" 2>/dev/null || true

  if [[ -r $cache_file ]]; then
    local -a cache_stat bin_stat
    if zstat -A cache_stat +mtime -- $cache_file 2>/dev/null &&
       zstat -A bin_stat +mtime -- $commands[zoxide] 2>/dev/null &&
       (( cache_stat[1] >= bin_stat[1] )); then
      cache_valid=1
    fi
  fi

  if (( cache_valid )); then
    source $cache_file
  else
    local init_output
    init_output=$(zoxide init zsh 2>/dev/null) || init_output=
    if [[ -n $init_output ]]; then
      print -r -- "$init_output" >$cache_file 2>/dev/null || true
      -z4m-compile $cache_file 2>/dev/null || true
      source $cache_file 2>/dev/null || eval "$init_output"
    fi
  fi
fi
