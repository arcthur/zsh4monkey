#!/usr/bin/env zsh

# Base64-decode a string.
# Usage: -z4m-b64dec <base64>
# Sets: reply[1] to decoded output

emulate -L zsh -o typeset_silent -o pipe_fail -o no_aliases

zmodload zsh/system 2>/dev/null || return 1

local b64=$1

# Validate as data-only payload.
[[ -n $b64 ]] || { reply=(""); return 0 }
[[ $b64 =~ '^[A-Za-z0-9+/=]+$' ]] || return 1

local tmp
tmp=$(command mktemp "${TMPDIR:-/tmp}/z4m-b64dec.XXXXXXXXXX" 2>/dev/null) || return 1

local -i rc=0
{
  print -r -- "$b64" | command base64 -d 2>/dev/null >| "$tmp" || rc=$?
  if (( rc != 0 )); then
    rc=0
    print -r -- "$b64" | command base64 -D 2>/dev/null >| "$tmp" || rc=$?
  fi
  (( rc == 0 )) || return 1

  local -i fd
  sysopen -r -u fd -- "$tmp" || return 1

  local out='' chunk
  while true; do
    sysread -i $fd -s 4096 chunk && { out+=$chunk; continue; }
    (( $? == 5 )) && break
    return 1
  done
  exec {fd}<&- 2>/dev/null || true

  reply=("$out")
  return 0
} always {
  command rm -f -- "$tmp" 2>/dev/null || true
}
