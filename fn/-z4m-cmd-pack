#!/usr/bin/env zsh
#
# z4m pack - Create an offline installation package
#
# Usage:
#   z4m pack [-o output] [-t tag]
#
# Creates a self-extracting script that can install z4m on machines
# without internet access.
#

emulate -L zsh -o typeset_silent -o pipe_fail -o extended_glob \
    -o prompt_percent -o no_prompt_subst -o no_prompt_bang -o no_bg_nice -o no_aliases
-z4m-check-core-params || return

local output= tag=
local -a extra_files=()

zparseopts -D -F -- o:=output t:=tag || return '_z4m_err()'

output=${output[2]:-z4m-offline-install.sh}
tag=${tag[2]:-default}

# Get extra files from zstyle
zstyle -a ":z4m:pack:$tag" extra-files extra_files || extra_files=()

print -Pr -- "%F{3}z4m%f: creating offline package: %F{2}${output//\%/%%}%f"

local tmpdir
if (( $+commands[mktemp] )); then
  tmpdir=$(command mktemp -d) || return
else
  tmpdir=/tmp/z4m-pack.$$
  zf_mkdir -p -- $tmpdir || return
fi

{
  # Files to include
  local -a pack_files=(
    $ZDOTDIR/.zshenv
    $ZDOTDIR/.zprofile
    $ZDOTDIR/.zshrc
    $ZDOTDIR/.zlogin
    $ZDOTDIR/.zlogout
    $ZDOTDIR/.p10k{,-ascii}{,-8color}.zsh(N)
  )

  # Add extra files
  local f
  for f in $extra_files; do
    eval "f=$f"
    [[ -e $f ]] && pack_files+=($f)
  done

  # Essential z4m directories
  local -a z4m_dirs=(
    $Z4M/zsh4monkey
    $Z4M/fzf
    $Z4M/powerlevel10k
    $Z4M/zsh-users
    $Z4M/terminfo
  )

  local -i i=0
  local indices=() file_map=()

  # Create symlinks for dotfiles
  for f in $pack_files; do
    [[ -e $f ]] || continue
    (( ++i ))
    zf_ln -s -- ${f:P} $tmpdir/f$i || return
    # Use basename for files outside ZDOTDIR
    local dst_name
    if [[ $f == $ZDOTDIR/* ]]; then
      dst_name=${f#$ZDOTDIR/}
    else
      dst_name=${f:t}
    fi
    file_map+=($i $dst_name)
  done

  # Create tarball of z4m installation
  local z4m_tar=$tmpdir/z4m.tar.gz
  {
    local -a tar_args=()
    for d in $z4m_dirs; do
      [[ -d $d ]] && tar_args+=(${d#$Z4M/})
    done
    if (( $#tar_args )); then
      COPYFILE_DISABLE=1 command tar -C $Z4M -czf $z4m_tar -- $tar_args
    fi
  } 2>/dev/null

  # Generate the self-extracting script
  {
    cat <<'HEADER'
#!/bin/sh
#
# z4m Offline Installation Package
# Generated by: z4m pack
#
# Usage: sh z4m-offline-install.sh [ZDOTDIR]
#
# This script installs z4m and its dependencies on a machine without
# internet access. Run it on the target machine.
#

set -e

ZDOTDIR="${1:-$HOME}"
Z4M="${Z4M:-${XDG_CACHE_HOME:-$HOME/.cache}/zsh4monkey}"

echo "Installing z4m to: $Z4M"
echo "ZDOTDIR: $ZDOTDIR"

# Create directories
mkdir -p "$Z4M"
mkdir -p "$ZDOTDIR"

# Extract embedded data
SCRIPT_PATH="$0"
MARKER='___Z4M_DATA_MARKER___'

# Find data offset
DATA_OFFSET=$(grep -n "^$MARKER\$" "$SCRIPT_PATH" | tail -1 | cut -d: -f1)
if [ -z "$DATA_OFFSET" ]; then
  echo "Error: Data marker not found" >&2
  exit 1
fi
DATA_OFFSET=$((DATA_OFFSET + 1))

# Extract to temp directory
TMPDIR=$(mktemp -d)
trap "rm -rf '$TMPDIR'" EXIT

b64decode() {
  base64 -d 2>/dev/null || base64 -D 2>/dev/null
}

tail -n +$DATA_OFFSET "$SCRIPT_PATH" | b64decode | tar -xzf - -C "$TMPDIR"

# Install z4m core
if [ -f "$TMPDIR/z4m.tar.gz" ]; then
  tar -xzf "$TMPDIR/z4m.tar.gz" -C "$Z4M"
  echo "Installed z4m core"
fi

# Install dotfiles
HEADER

    # Output file installation commands
    local idx name
    for idx name in $file_map; do
      print -r -- "[ -f \"\$TMPDIR/f$idx\" ] && cp \"\$TMPDIR/f$idx\" \"\$ZDOTDIR/$name\" && echo \"Installed $name\""
    done

    cat <<'FOOTER'

echo ""
echo "Installation complete!"
echo ""
echo "To use z4m, start a new zsh session:"
echo "  exec zsh"
echo ""

exit 0

___Z4M_DATA_MARKER___
FOOTER

    # Append the data payload (base64 encoded tar)
    {
      COPYFILE_DISABLE=1 command tar -C $tmpdir -czf - .
    } | base64

  } > $output || return

  chmod +x $output

  print -Pr -- "%F{3}z4m%f: created %F{2}${output//\%/%%}%f ($(command du -h $output | cut -f1))"
  print -Pr -- ""
  print -Pr -- "To install on a remote machine without internet:"
  print -Pr -- "  1. Copy %B${output//\%/%%}%b to the target machine"
  print -Pr -- "  2. Run: %Bsh ${output//\%/%%}%b"

} always {
  zf_rm -rf -- $tmpdir
}
