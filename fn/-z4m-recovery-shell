#!/usr/bin/env zsh
#
# z4m-recovery-shell - Minimal recovery shell when configuration breaks
#
# This provides a safe environment to fix broken .zshrc configurations.
# All z4m features are disabled, only basic zsh functionality remains.
#

# Use builtin commands explicitly to avoid functions shadowing them
'emulate' '-L' 'zsh' '-o' 'no_aliases'

# Save current state
'local' _z4m_recovery_old_prompt=${PS1:-'%n@%m %~ %# '}
'local' _z4m_recovery_old_rprompt=${RPS1:-}

# Enter recovery mode
() {
  'emulate' '-L' 'zsh' '-o' 'no_aliases'

  # Load add-zsh-hook if not already available
  'autoload' '-Uz' 'add-zsh-hook' 2>/dev/null

  # Disable all z4m hooks and widgets
  'local' hook
  for hook in chpwd precmd preexec periodic zshaddhistory zshexit; do
    add-zsh-hook -D $hook '*z4m*' 2>/dev/null || 'true'
  done

  # Reset to default key bindings
  'bindkey' '-d'
  'bindkey' '-e'

  # Set minimal prompt indicating recovery mode
  PS1=$'%F{yellow}[RECOVERY]%f %F{red}%n@%m%f %F{blue}%~%f %# '
  RPS1=''

  # Disable autosuggestions and syntax highlighting if loaded
  (( ${+ZSH_AUTOSUGGEST_HIGHLIGHT_STYLE} )) && ZSH_AUTOSUGGEST_HIGHLIGHT_STYLE=''
  (( ${+ZSH_HIGHLIGHT_HIGHLIGHTERS} )) && ZSH_HIGHLIGHT_HIGHLIGHTERS=()

  # Basic useful aliases
  'alias' ls='command ls --color=auto 2>/dev/null || command ls'
  'alias' ll='ls -la'
  'alias' grep='command grep --color=auto'

  # Define recovery helper functions
  function z4m-recovery-edit() {
    'local' editor=${EDITOR:-${VISUAL:-vi}}
    if [[ -n $1 ]]; then
      "$editor" "$1"
    else
      "$editor" "${ZDOTDIR:-$HOME}/.zshrc"
    fi
  }

  function z4m-recovery-reload() {
    'print' -P '%F{yellow}Attempting to reload zsh configuration...%f'
    'exec' 'zsh' '-i'
  }

  function z4m-recovery-exit() {
    'print' -P '%F{green}Exiting recovery mode and reloading zsh...%f'
    'exec' 'zsh' '-i'
  }

  function z4m-recovery-safe-exit() {
    'print' -P '%F{cyan}Exiting to safe mode (plugins disabled)...%f'
    'export' 'Z4M_SAFE_MODE=1'
    'exec' 'zsh' '-i'
  }

  function z4m-recovery-clear-state() {
    'local' z4m_dir=${Z4M:-$HOME/.cache/zsh4monkey}
    'print' -P '%F{yellow}Clearing failure state...%f'
    command rm -f -- "$z4m_dir"/.last-init-failed 2>/dev/null
    command rm -f -- "$z4m_dir"/.safe-mode 2>/dev/null
    command rm -f -- "$z4m_dir"/cache/last-init-failed.log 2>/dev/null
    'print' -P '%F{green}State cleared. Reloading zsh normally...%f'
    'exec' 'zsh' '-i'
  }

  function z4m-recovery-diagnose() {
    'local' z4m_dir=${Z4M:-$HOME/.cache/zsh4monkey}
    'print' -P '%F{cyan}=== z4m Recovery Diagnostics ===%f'
    'print' ''

    # Check for failure marker and show log
    -z4m-show-failure-log "$z4m_dir"
    'print' ''

    # Check safe mode trigger
    if [[ -e $z4m_dir/.safe-mode ]]; then
      'print' -P '%F{yellow}Persistent safe mode is enabled.%f'
      'print' -P "File: $z4m_dir/.safe-mode"
    fi

    # Show key paths
    'print' -P '%F{cyan}Key paths:%f'
    'print' -P "  ZDOTDIR: ${ZDOTDIR:-$HOME}"
    'print' -P "  Z4M:     $z4m_dir"
    'print' -P "  .zshrc:  ${ZDOTDIR:-$HOME}/.zshrc"
    'print' ''

    # Check for syntax errors in .zshrc
    'print' -P '%F{cyan}Checking .zshrc syntax...%f'
    if zsh -n "${ZDOTDIR:-$HOME}/.zshrc" 2>&1; then
      'print' -P '%F{green}No syntax errors found.%f'
    else
      'print' -P '%F{red}Syntax errors detected! See above.%f'
    fi
    'print' ''

    # Check installed plugins
    'print' -P '%F{cyan}Installed plugins:%f'
    'local' plugin
    for plugin in $z4m_dir/*(N/:t); do
      [[ $plugin == cache || $plugin == .* ]] && continue
      'print' -P "  $plugin"
    done
  }

  function z4m-recovery-help() {
    'print' -P '%F{cyan}z4m Recovery Shell%f'
    'print' ''
    'print' -P 'You are in a minimal recovery environment because z4m'
    'print' -P 'initialization failed or you entered recovery mode manually.'
    'print' ''
    'print' -P '%F{yellow}Available commands:%f'
    'print' -P '  %Bz4m-recovery-edit%b [file]   Edit .zshrc (or specified file)'
    'print' -P '  %Bz4m-recovery-reload%b        Reload zsh configuration'
    'print' -P '  %Bz4m-recovery-exit%b          Exit recovery and restart zsh'
    'print' -P '  %Bz4m-recovery-safe-exit%b     Restart in safe mode (plugins disabled)'
    'print' -P '  %Bz4m-recovery-clear-state%b   Clear failure markers and restart'
    'print' -P '  %Bz4m-recovery-diagnose%b      Show diagnostic information'
    'print' -P '  %Bz4m-recovery-help%b          Show this help'
    'print' ''
    'print' -P '%F{yellow}Common fixes:%f'
    'print' -P '  1. Run %Bz4m-recovery-diagnose%b to check for issues'
    'print' -P '  2. Edit ~/.zshrc to fix syntax errors'
    'print' -P '  3. Comment out problematic plugin lines'
    'print' -P '  4. Run %Bz4m-recovery-reload%b to test'
    'print' ''
    'print' -P '%F{yellow}Useful paths:%f'
    'print' -P "  ZDOTDIR: ${ZDOTDIR:-$HOME}"
    'print' -P "  Z4M:     ${Z4M:-\$HOME/.cache/zsh4monkey}"
  }

  # Define stub z4m command to prevent errors in .zshrc
  function z4m() {
    case ${1-} in
      init)
        # Already in recovery mode, skip initialization
        return 0
        ;;
      install|source|load|bindkey)
        # Silently ignore plugin/binding commands in recovery mode
        return 0
        ;;
      recovery)
        'print' -P '%F{yellow}Already in recovery mode.%f'
        return 0
        ;;
      *)
        'print' -P '%F{yellow}z4m%f: running in recovery mode, command ignored: %B'${1:-help}'%b'
        return 0
        ;;
    esac
  }

  # Show welcome message
  'print' ''
  'print' -P '%F{yellow}=== z4m Recovery Shell ===%f'
  'print' -P 'Type %Bz4m-recovery-help%b for available commands.'
  'print' ''
}
